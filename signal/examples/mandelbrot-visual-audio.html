<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Mandelbrot Infinite Journey - Visual + Audio</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-family: monospace;
      color: #0f0;
    }

    canvas {
      border: 2px solid #0f0;
      image-rendering: pixelated;
    }

    #info {
      margin-top: 20px;
      font-size: 14px;
      text-align: center;
      line-height: 1.8;
    }

    .stat {
      color: #0ff;
    }

    h1 {
      font-size: 24px;
      margin: 10px;
      color: #0f0;
      text-shadow: 0 0 10px #0f0;
    }

    button {
      font-size: 18px;
      padding: 15px 30px;
      margin: 20px;
      background: #0f0;
      color: #000;
      border: none;
      cursor: pointer;
      font-family: monospace;
      font-weight: bold;
      text-shadow: 0 0 5px #0f0;
    }

    button:hover {
      background: #0ff;
    }
  </style>
</head>
<body>
  <h1>∞ MANDELBROT INFINITE JOURNEY ∞</h1>
  <button id="startBtn">▶ START JOURNEY</button>
  <canvas id="canvas" width="200" height="150"></canvas>
  <div id="info">
    <div>Time: <span class="stat" id="time">0.0s</span></div>
    <div>Zoom: <span class="stat" id="zoom">1x</span></div>
    <div>Location: <span class="stat" id="location">Infinite Spiral</span></div>
    <div>Max Depth: <span class="stat" id="depth">50</span></div>
    <div>Audio: <span class="stat" id="audioStatus">Ready</span></div>
  </div>

  <script>
    'use strict';

    // ========================================================================
    // Y-COMBINATOR
    // ========================================================================

    const Y = f => (x => x(x))(x => f((...args) => x(x)(...args)));

    // ========================================================================
    // MANDELBROT WITH Y-COMBINATOR
    // ========================================================================

    const musicalMandelbrot = (cx, cy, maxDepth = 50) =>
      Y(recurse => (zx, zy, depth) => {
        if (depth >= maxDepth) return depth;
        if (zx * zx + zy * zy > 4) return depth;

        const zx2 = zx * zx - zy * zy;
        const zy2 = 2 * zx * zy;

        return recurse(zx2 + cx, zy2 + cy, depth + 1);
      })(0, 0, 0);

    // ========================================================================
    // MUSICAL UTILITIES
    // ========================================================================

    const scales = {
      minor: [0, 2, 3, 5, 7, 8, 10]
    };

    function freq(root, scale, degree) {
      const octaves = Math.floor(degree / scale.length);
      const scaleDegree = degree % scale.length;
      const semitones = scale[scaleDegree] + (octaves * 12);
      return root * Math.pow(2, semitones / 12);
    }

    function step(t, bpm, steps) {
      const beatDuration = 60 / bpm;
      const stepDuration = beatDuration / (steps / 4);
      const index = t / stepDuration;
      const phase = (t % stepDuration) / stepDuration;
      return { index, phase };
    }

    function expEnv(phase, steepness) {
      return Math.exp(-phase * steepness);
    }

    // ========================================================================
    // ZOOM TARGET - Classic spiral location with infinite detail
    // ========================================================================

    const zoomTarget = { x: -0.7436438870, y: 0.1318259044, name: 'Infinite Spiral' };

    // ========================================================================
    // WEB AUDIO SETUP
    // ========================================================================

    let audioContext;
    let startTime;
    let isPlaying = false;

    function initAudio() {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      startTime = audioContext.currentTime;
      document.getElementById('audioStatus').textContent = 'Playing';
    }

    // Audio synthesis using ScriptProcessorNode
    function startAudio() {
      if (isPlaying) return;
      isPlaying = true;

      const bufferSize = 4096;
      const processor = audioContext.createScriptProcessor(bufferSize, 1, 2);

      processor.onaudioprocess = (e) => {
        const outputL = e.outputBuffer.getChannelData(0);
        const outputR = e.outputBuffer.getChannelData(1);

        for (let i = 0; i < bufferSize; i++) {
          const t = audioContext.currentTime - startTime + (i / audioContext.sampleRate);

          // Same audio generation as Bun version!
          const sample = infiniteZoomAudio(t);

          outputL[i] = sample;
          outputR[i] = sample;
        }
      };

      processor.connect(audioContext.destination);
    }

    // ========================================================================
    // AUDIO GENERATOR (same as Bun version!)
    // ========================================================================

    function infiniteZoomAudio(t) {
      // Continuous zoom into the spiral
      const zoom = Math.pow(2, t / 10);

      const width = 2 / zoom;
      // Slight drift as we zoom for more interesting visuals
      const cx = zoomTarget.x + Math.cos(t * 0.1) * width * 0.05;
      const cy = zoomTarget.y + Math.sin(t * 0.1) * width * 0.05;

      const maxDepth = Math.floor(100 + Math.log2(zoom) * 15);
      const escape = musicalMandelbrot(cx, cy, maxDepth);

      const scaleIndex = Math.floor(Math.log2(zoom)) % 7;
      const degree = (escape + scaleIndex) % 7;
      const octave = Math.floor(escape / 7) % 3;

      const { phase } = step(t, 60, 8);
      const f = freq(220 * (octave + 1), scales.minor, degree);

      const envelope = expEnv(phase, 1.0);

      return Math.sin(2 * Math.PI * f * t) * envelope * 0.15;
    }

    // ========================================================================
    // VISUAL RENDERING
    // ========================================================================

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;

    function escapeTimeToColor(escape, maxDepth) {
      if (escape === maxDepth) {
        return [0, 0, 0];
      }

      const degree = escape % 8;
      const octave = Math.floor(escape / 8) % 3;

      const hue = (degree / 8) * 360;
      const saturation = 70 + (octave * 10);
      const lightness = 30 + (escape / maxDepth) * 50;

      const c = (1 - Math.abs(2 * lightness/100 - 1)) * saturation/100;
      const x = c * (1 - Math.abs((hue/60) % 2 - 1));
      const m = lightness/100 - c/2;

      let r, g, b;
      if (hue < 60) { r = c; g = x; b = 0; }
      else if (hue < 120) { r = x; g = c; b = 0; }
      else if (hue < 180) { r = 0; g = c; b = x; }
      else if (hue < 240) { r = 0; g = x; b = c; }
      else if (hue < 300) { r = x; g = 0; b = c; }
      else { r = c; g = 0; b = x; }

      return [
        Math.round((r + m) * 255),
        Math.round((g + m) * 255),
        Math.round((b + m) * 255)
      ];
    }

    let frameCount = 0;
    function render() {
      if (!isPlaying) return;

      // Only render visual every 2nd frame (30fps instead of 60fps)
      frameCount++;
      const t = audioContext.currentTime - startTime;

      if (frameCount % 2 !== 0) {
        requestAnimationFrame(render);
        return;
      }

      // Same calculations as audio - continuous zoom!
      const zoom = Math.pow(2, t / 10);

      const width_view = 2 / zoom;
      const centerX = zoomTarget.x + Math.cos(t * 0.1) * width_view * 0.05;
      const centerY = zoomTarget.y + Math.sin(t * 0.1) * width_view * 0.05;

      const maxDepth = Math.floor(100 + Math.log2(zoom) * 15);

      // Update display
      document.getElementById('time').textContent = t.toFixed(1) + 's';
      document.getElementById('zoom').textContent = zoom.toExponential(2) + 'x';
      document.getElementById('location').textContent = zoomTarget.name;
      document.getElementById('depth').textContent = maxDepth;

      // Render Mandelbrot
      const imageData = ctx.createImageData(width, height);
      const data = imageData.data;

      const step = 6; // Render every 6th pixel for performance

      // Pre-calculate constants for performance
      const halfWidth = width / 2;
      const halfHeight = height / 2;
      const scaleX = width_view / width;
      const scaleY = width_view / height;

      for (let py = 0; py < height; py += step) {
        for (let px = 0; px < width; px += step) {
          const x = centerX + (px - halfWidth) * scaleX;
          const y = centerY + (py - halfHeight) * scaleY;

          const escape = musicalMandelbrot(x, y, maxDepth);
          const [r, g, b] = escapeTimeToColor(escape, maxDepth);

          for (let dy = 0; dy < step; dy++) {
            for (let dx = 0; dx < step; dx++) {
              const i = ((py + dy) * width + (px + dx)) * 4;
              if (i < data.length) {
                data[i] = r;
                data[i + 1] = g;
                data[i + 2] = b;
                data[i + 3] = 255;
              }
            }
          }
        }
      }

      ctx.putImageData(imageData, 0, 0);

      requestAnimationFrame(render);
    }

    // ========================================================================
    // START BUTTON
    // ========================================================================

    document.getElementById('startBtn').addEventListener('click', () => {
      document.getElementById('startBtn').style.display = 'none';
      initAudio();
      startAudio();
      render();
      console.log('Journey started! Audio and visual in perfect sync.');
    });
  </script>
</body>
</html>
